<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>DOOM Style Shooter - Fixed Gun Bobbing & Mobile</title>
<style>
html, body { margin:0; padding:0; overflow:hidden; background:#222; font-family:sans-serif; }
canvas { display:block; }
#gun {
  position:absolute;
  bottom:0;
  left:50%;
  transform:translateX(-50%);
  image-rendering:pixelated;
  height:50%;
  pointer-events:none;
  user-select:none;
}
#startUI {
  position:absolute;
  width:100%; height:100%;
  background:rgba(0,0,0,0.95);
  display:flex; flex-direction:column; justify-content:center; align-items:center;
  color:white; z-index:10;
}
#startUI button {
  font-size:2em; padding:1em 2em; margin:1em; cursor:pointer;
  background:#444; color:white; border:none; border-radius:10px;
}
#mobileControls {
  position:absolute; bottom:0; width:100%; height:40%;
  display:flex; justify-content:space-between; align-items:flex-end; pointer-events:none;
}
.joystick, #shootButton {
  pointer-events:auto; background:rgba(255,255,255,0.2); border-radius:50%;
}
.joystick { width:120px; height:120px; margin:20px; position:relative; touch-action:none; }
.joystickInner {
  width:60px; height:60px; background:rgba(255,255,255,0.5); border-radius:50%; position:absolute; left:30px; top:30px;
}
#shootButton { width:100px; height:100px; margin:20px; display:flex; justify-content:center; align-items:center; font-size:1.5em; color:white; }
</style>
</head>
<body>
<div id="startUI">
  <h1>DOOM Style Shooter</h1>
  <p>Choose your platform:</p>
  <button id="pcButton">PC</button>
  <button id="mobileButton">Mobile</button>
</div>

<img id="gun" src="gun.png" />

<div id="mobileControls" style="display:none;">
  <div class="joystick"><div class="joystickInner"></div></div>
  <div id="shootButton">FIRE</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<script>
let scene = new THREE.Scene()
let camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000)
let renderer = new THREE.WebGLRenderer({antialias:false})
renderer.setSize(window.innerWidth, window.innerHeight)
document.body.appendChild(renderer.domElement)

let ambientLight = new THREE.AmbientLight(0xffffff, 0.7)
scene.add(ambientLight)
let dirLight = new THREE.DirectionalLight(0xffffff, 0.5)
dirLight.position.set(1,2,3)
scene.add(dirLight)

const textureLoader = new THREE.TextureLoader()
const wallTexture = textureLoader.load("wall.png")
wallTexture.magFilter = THREE.NearestFilter

const floor = new THREE.Mesh(
  new THREE.PlaneGeometry(200, 200),
  new THREE.MeshBasicMaterial({color: 0x555555})
)
floor.rotation.x = -Math.PI / 2
scene.add(floor)

// MAZE layout (predefined, GitHub-friendly)
const mazeLayout = [
  "##########",
  "#        #",
  "#  ##    #",
  "#  ##    #",
  "#        #",
  "#   ##   #",
  "#   ##   #",
  "#        #",
  "#        #",
  "##########"
]
const wallSize = 10
for(let i=0;i<mazeLayout.length;i++){
  for(let j=0;j<mazeLayout[i].length;j++){
    if(mazeLayout[i][j]==="#"){
      const wall = new THREE.Mesh(
        new THREE.BoxGeometry(wallSize,10,wallSize),
        new THREE.MeshPhongMaterial({map:wallTexture})
      )
      wall.position.set(j*wallSize,5,i*wallSize)
      scene.add(wall)
    }
  }
}

camera.position.set(wallSize*1.5,2,wallSize*1.5)
camera.rotation.order = 'YXZ'

const gunImg = document.getElementById("gun")
const gunFrames = ["gun.png","gun1.png","gun2.png","gun3.png","gun4.png","gun3.png","gun2.png","gun1.png","gun.png"]

let firing = false
let frameIndex = 0
let fireCooldown = false

function fireGun(){
  if(firing || fireCooldown) return
  firing = true
  fireCooldown = true
  let interval = setInterval(() => {
    gunImg.src = gunFrames[frameIndex]
    frameIndex++
    if(frameIndex>=gunFrames.length){
      clearInterval(interval)
      frameIndex=0
      firing=false
      setTimeout(()=>fireCooldown=false,400)
    }
  },120)
}

// KEYBOARD input
let keys = {}
window.addEventListener("keydown", e => {
  if(e.code==="Space") fireGun()
  keys[e.key.toLowerCase()] = true
})
window.addEventListener("keyup", e => keys[e.key.toLowerCase()] = false)

// POINTER LOCK
let isPointerLocked = false
document.body.requestPointerLock = document.body.requestPointerLock || document.body.mozRequestPointerLock
document.body.onclick = () => { if(!isPointerLocked){document.body.requestPointerLock()} }
document.addEventListener('pointerlockchange', ()=>{ isPointerLocked=!!document.pointerLockElement })
window.addEventListener('mousemove', e => {
  if(isPointerLocked){
    camera.rotation.y -= e.movementX * 0.002
  }
})

// MOBILE controls
let mobileMode = false
const joystick = document.querySelector('.joystick')
const joystickInner = document.querySelector('.joystickInner')
let joyX=0, joyY=0, joystickActive=false

joystick.addEventListener('touchstart', e=>{ joystickActive=true })
joystick.addEventListener('touchmove', e=>{
  if(!joystickActive) return
  const rect=joystick.getBoundingClientRect()
  const touch = e.touches[0]
  joyX = (touch.clientX-(rect.left+rect.width/2))/rect.width*2
  joyY = (touch.clientY-(rect.top+rect.height/2))/rect.height*2
  joystickInner.style.transform = `translate(${joyX*30}px, ${joyY*30}px)`
})
joystick.addEventListener('touchend', e=>{ joystickActive=false; joyX=0; joyY=0; joystickInner.style.transform='translate(0,0)' })

document.getElementById("shootButton").addEventListener('touchstart', fireGun)

// START UI
document.getElementById("pcButton").onclick = ()=>{
  document.getElementById("startUI").style.display="none"
  mobileMode=false
}
document.getElementById("mobileButton").onclick = ()=>{
  document.getElementById("startUI").style.display="none"
  document.getElementById("mobileControls").style.display="flex"
  mobileMode=true
}

let clock = new THREE.Clock()
let bobPhase=0

function animate(){
  requestAnimationFrame(animate)
  let dt = clock.getDelta()
  let walking=false
  let speed = 5*dt

  if(mobileMode){
    camera.position.x -= Math.sin(camera.rotation.y)*joyY*speed
    camera.position.z -= Math.cos(camera.rotation.y)*joyY*speed
    camera.position.x += Math.cos(camera.rotation.y)*joyX*speed
    camera.position.z -= Math.sin(camera.rotation.y)*joyX*speed
    walking = Math.abs(joyX)>0.1 || Math.abs(joyY)>0.1
  } else {
    if(keys["w"]){ camera.position.x -= Math.sin(camera.rotation.y)*speed; camera.position.z -= Math.cos(camera.rotation.y)*speed; walking=true }
    if(keys["s"]){ camera.position.x += Math.sin(camera.rotation.y)*speed; camera.position.z += Math.cos(camera.rotation.y)*speed; walking=true }
    if(keys["a"]){ camera.position.x -= Math.cos(camera.rotation.y)*speed; camera.position.z += Math.sin(camera.rotation.y)*speed; walking=true }
    if(keys["d"]){ camera.position.x += Math.cos(camera.rotation.y)*speed; camera.position.z -= Math.sin(camera.rotation.y)*speed; walking=true }
  }

  camera.position.y=2

  if(walking){
    bobPhase+=dt*12
    let xBob=Math.sin(bobPhase*2)*5
    let yBob=Math.abs(Math.sin(bobPhase))*7
    gunImg.style.transform = `translateX(calc(-50% + ${xBob}px)) translateY(-${yBob}px)`
  } else {
    gunImg.style.transform = 'translateX(-50%) translateY(0)'
  }

  renderer.render(scene,camera)
}

animate()

window.addEventListener("resize", ()=>{
  camera.aspect = window.innerWidth/window.innerHeight
  camera.updateProjectionMatrix()
  renderer.setSize(window.innerWidth, window.innerHeight)
})
</script>
</body>
</html>
