<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>de_dust2 Web Walkaround</title>
<style>
html,body{margin:0;height:100%;overflow:hidden;background:#000}
canvas{display:block}
</style>
</head>
<body>
<script type="module">
import * as THREE from 'https://unpkg.com/three@0.161.1/build/three.module.js';
import { MTLLoader } from 'https://unpkg.com/three@0.161.1/examples/jsm/loaders/MTLLoader.js';
import { OBJLoader } from 'https://unpkg.com/three@0.161.1/examples/jsm/loaders/OBJLoader.js';
import { TGALoader } from 'https://unpkg.com/three@0.161.1/examples/jsm/loaders/TGALoader.js';
import { AmmoPhysics } from 'https://unpkg.com/@enable3d/ammo-physics@1.14.1/dist/ammo-physics.module.js';

let scene, camera, renderer, physics, player;
let move={f:0,b:0,l:0,r:0};

init();
animate();

async function init(){
  scene=new THREE.Scene();
  scene.background=new THREE.Color(0x87ceeb);
  camera=new THREE.PerspectiveCamera(75,innerWidth/innerHeight,0.1,2000);
  renderer=new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(innerWidth,innerHeight);
  document.body.appendChild(renderer.domElement);
  const light=new THREE.DirectionalLight(0xffffff,1);
  light.position.set(10,20,10);
  scene.add(new THREE.AmbientLight(0xffffff,0.4),light);
  physics=new AmmoPhysics(scene);
  physics.debug.enable(false);

  const tga=new TGALoader();
  const mtl=new MTLLoader();mtl.setTextureLoader(tga);
  mtl.load('de_dust2.mtl',m=>{
    m.preload();
    const obj=new OBJLoader();obj.setMaterials(m);
    obj.load('de_dust2.obj',o=>{
      o.traverse(c=>{
        if(c.isMesh){c.castShadow=true;c.receiveShadow=true;physics.add.existing(c,{mass:0,shape:'concave'});}
      });
      scene.add(o);
    });
  });

  const radius=0.5,height=1.8;
  const shape=new Ammo.btCapsuleShape(radius,height-2*radius);
  player=physics.add.existing(new THREE.Object3D(),{mass:80,shape});
  player.body.setActivationState(4);
  player.position.set(0,5,0);

  addListeners();
}

function addListeners(){
  window.addEventListener('resize',()=>{
    camera.aspect=innerWidth/innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(innerWidth,innerHeight);
  });
  document.body.addEventListener('click',()=>renderer.domElement.requestPointerLock());
  document.addEventListener('mousemove',e=>{
    if(document.pointerLockElement===renderer.domElement){
      player.rotation.y-=e.movementX*0.002;
      camera.rotation.x-=e.movementY*0.002;
      camera.rotation.x=Math.max(-Math.PI/2,Math.min(Math.PI/2,camera.rotation.x));
    }
  });
  document.addEventListener('keydown',e=>{
    if(e.key==='w')move.f=1;if(e.key==='s')move.b=1;
    if(e.key==='a')move.l=1;if(e.key==='d')move.r=1;
  });
  document.addEventListener('keyup',e=>{
    if(e.key==='w')move.f=0;if(e.key==='s')move.b=0;
    if(e.key==='a')move.l=0;if(e.key==='d')move.r=0;
  });
}

function animate(){
  requestAnimationFrame(animate);
  const speed=8;
  const f=new THREE.Vector3();player.getWorldDirection(f);f.y=0;f.normalize();
  const r=new THREE.Vector3();r.crossVectors(new THREE.Vector3(0,1,0),f).normalize();
  const vel=player.body.getLinearVelocity();
  const x=(move.r-move.l)*speed,z=(move.b-move.f)*speed;
  const nv=new Ammo.btVector3(f.x*-z+r.x*x,vel.y(),f.z*-z+r.z*x);
  player.body.setLinearVelocity(nv);
  camera.position.copy(player.position).add(new THREE.Vector3(0,1.2,0));
  camera.rotation.y=player.rotation.y;
  physics.update(1/60);
  renderer.render(scene,camera);
}
</script>
</body>
</html>
